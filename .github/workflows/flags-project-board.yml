name: Add PR to Feature Flags Project

env:
    PROJECT_V2_ID: PVT_kwDOAgyiKM4A7GJu
    STATUS_FIELD_ID: PVTSSF_lADOAgyiKM4A7GJuzgvfuDU
    IN_REVIEW_OPTION_ID: 0c52b517 # Status: In Review
    IN_PROGRESS_OPTION_ID: 47fc9ee4 # Status: In Progress
    ORG_NAME: haacked-demos
    TEAM_SLUG: developers

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'The number of the pull request'
                required: true
                type: number
            repository:
                description: 'The repository name (e.g. todo-app)'
                required: true
                type: string
            pr_node_id:
                description: 'The node ID of the pull request (optional, will be looked up if not provided)'
                required: false
                type: string
            is_draft:
                description: 'Whether the pull request is in draft mode'
                required: true
                type: boolean
    workflow_call:
        inputs:
            pr_number:
                description: 'The number of the pull request'
                required: true
                type: number
            repository:
                description: 'The repository name (e.g. todo-app)'
                required: true
                type: string
            pr_node_id:
                description: 'The node ID of the pull request (optional, will be looked up if not provided)'
                required: false
                type: string
            is_draft:
                description: 'Whether the pull request is in draft mode'
                required: true
                type: boolean
    pull_request:
        types: [opened, ready_for_review, review_requested, synchronize]

jobs:
    add-to-project-v2:
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'workflow_dispatch' || 
            github.event_name == 'workflow_call' || 
            startsWith(github.repository, format('{0}/', github.env.ORG_NAME))
        steps:
            - name: Get PR Node ID if not provided
              id: get-pr
              if: |
                (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && 
                !github.event.inputs.pr_node_id
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}
                  script: |
                      const prNumber = ${{ github.event.inputs.pr_number }};
                      const repo = '${{ github.event.inputs.repository }}';
                      const owner = process.env.ORG_NAME;
                      
                      const { data: pr } = await github.rest.pulls.get({
                          owner,
                          repo,
                          pull_number: prNumber
                      });
                      
                      core.setOutput('node_id', pr.node_id);
                      core.setOutput('is_draft', pr.draft);

            - name: Determine PR status and desired project status
              id: check
              uses: actions/github-script@v6
              env:
                  IN_REVIEW_OPTION_ID: '${{ env.IN_REVIEW_OPTION_ID }}'
                  IN_PROGRESS_OPTION_ID: '${{ env.IN_PROGRESS_OPTION_ID }}'
                  ORG_NAME: '${{ env.ORG_NAME }}'
                  TEAM_SLUG: '${{ env.TEAM_SLUG }}'
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}
                  script: |
                      let pr;
                      let isDraft;
                      let nodeId;
                      
                      if (github.event_name === 'pull_request') {
                          pr = context.payload.pull_request;
                          isDraft = pr.draft;
                          nodeId = pr.node_id;
                      } else {
                          if (github.event.inputs.pr_node_id) {
                              nodeId = github.event.inputs.pr_node_id;
                          } else {
                              nodeId = steps['get-pr'].outputs.node_id;
                          }
                          
                          pr = await github.rest.pulls.get({
                              owner: process.env.ORG_NAME,
                              repo: '${{ github.event.inputs.repository }}',
                              pull_number: ${{ github.event.inputs.pr_number }}
                          });
                          isDraft = ${{ github.event.inputs.is_draft }};
                      }
                      
                      const owner = process.env.ORG_NAME;
                      const repo = pr.base.repo.name;
                      const prNumber = pr.number;
                      const teamSlug = process.env.TEAM_SLUG;

                      core.info(`Evaluating PR #${prNumber} (draft: ${isDraft})`);

                      let isTeamRequested = false;
                      let isMemberRequested = false;

                      if (!isDraft) {
                        const { data: reviewers } = await github.rest.pulls.listRequestedReviewers({
                          owner,
                          repo,
                          pull_number: prNumber
                        });

                        isTeamRequested = reviewers.team_reviewers.some(t => t.slug === teamSlug);

                        for (const user of reviewers.users) {
                          try {
                            await github.rest.teams.getMembershipForUserInOrg({
                              org: owner,
                              team_slug: teamSlug,
                              username: user.login
                            });
                            isMemberRequested = true;
                            break;
                          } catch {}
                        }
                      }

                      let statusOptionId = null;

                      if (isDraft) {
                        core.info("PR is a draft. Setting status to 'In Progress'.");
                        statusOptionId = process.env.IN_PROGRESS_OPTION_ID;
                      } else if (isTeamRequested || isMemberRequested) {
                        core.info("PR is ready and relevant team reviewer found. Setting status to 'In Review'.");
                        statusOptionId = process.env.IN_REVIEW_OPTION_ID;
                      } else {
                        core.info("PR is not relevant to team-feature-flags. Skipping.");
                      }

                      const shouldAdd = statusOptionId !== null;
                      core.setOutput('should_add', shouldAdd.toString());
                      core.setOutput('pr_node_id', nodeId);
                      core.setOutput('status_option_id', statusOptionId ?? '');

            - name: Add PR to Project V2 if not already present
              if: steps.check.outputs.should_add == 'true'
              uses: actions/github-script@v6
              env:
                  PROJECT_V2_ID: ${{ env.PROJECT_V2_ID }}
                  STATUS_FIELD_ID: ${{ env.STATUS_FIELD_ID }}
                  PR_NODE_ID: ${{ steps.check.outputs.pr_node_id }}
                  STATUS_OPTION_ID: ${{ steps.check.outputs.status_option_id }}
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}
                  script: |
                      const projectId = process.env.PROJECT_V2_ID;
                      const fieldId = process.env.STATUS_FIELD_ID;
                      const optionId = process.env.STATUS_OPTION_ID;
                      const contentId = process.env.PR_NODE_ID;

                      core.info("Checking if PR is already in the project...");

                      const query = `
                        query($projectId: ID!) {
                          node(id: $projectId) {
                            ... on ProjectV2 {
                              items(first: 100) { # Limit is sufficient for our team size
                                nodes {
                                  id
                                  content {
                                    ... on PullRequest { id }
                                  }
                                }
                              }
                            }
                          }
                        }
                      `;

                      const result = await github.graphql(query, { projectId });
                      const items = result.node.items.nodes;

                      let existingItemId = null;
                      for (const item of items) {
                        if (item.content?.id === contentId) {
                          existingItemId = item.id;
                          break;
                        }
                      }

                      if (existingItemId) {
                        core.info("PR already exists in project. Updating status field...");
                      } else {
                        core.info("PR not found in project. Adding...");
                        const addItemMutation = `
                          mutation($projectId: ID!, $contentId: ID!) {
                            addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                              item { id }
                            }
                          }
                        `;

                        const response = await github.graphql(addItemMutation, { projectId, contentId });
                        existingItemId = response.addProjectV2ItemById.item.id;
                      }

                      const updateStatusMutation = `
                        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                          updateProjectV2ItemFieldValue(input: {
                            projectId: $projectId,
                            itemId: $itemId,
                            fieldId: $fieldId,
                            value: { singleSelectOptionId: $optionId }
                          }) {
                            projectV2Item { id }
                          }
                        }
                      `;

                      try {
                        await github.graphql(updateStatusMutation, {
                          projectId,
                          itemId: existingItemId,
                          fieldId,
                          optionId
                        });
                        core.info(`PR status set to option ID: ${optionId}`);
                      } catch (error) {
                        core.setFailed(`Failed to update PR status: ${error.message}`);
                      }
